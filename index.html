<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8">
  <title>画面共有 WebRTC</title>
  <style>
    body { font-family: sans-serif; padding: 20px; }
    video { width: 300px; border: 1px solid #ccc; margin: 10px 0; }
    textarea { width: 100%; height: 120px; font-family: monospace; }
    button { margin: 5px; padding: 8px 12px; }
  </style>
</head>
<body>

<h1>スマホ画面共有 - WebRTC版</h1>

<button id="startShare">画面共有（送信者）</button>
<button id="startReceive">受信（受信者）</button>

<div>
  <h2>ローカル映像（送信者）</h2>
  <video id="localVideo" autoplay muted playsinline></video>

  <h2>受信映像（受信者）</h2>
  <video id="remoteVideo" autoplay playsinline></video>
</div>

<h3>SDPの送受信（手動シグナリング）</h3>
<textarea id="signalData" placeholder="ここにSDPを貼り付けてください"></textarea><br>
<button id="setSignal">セットして接続</button>

<script>
  const startShareBtn = document.getElementById('startShare');
  const startReceiveBtn = document.getElementById('startReceive');
  const setSignalBtn = document.getElementById('setSignal');
  const signalData = document.getElementById('signalData');
  const localVideo = document.getElementById('localVideo');
  const remoteVideo = document.getElementById('remoteVideo');

  let pc;
  let localStream;

  const config = { iceServers: [{ urls: 'stun:stun.l.google.com:19302' }] };

  // 送信者側：画面共有を開始
  startShareBtn.onclick = async () => {
    pc = new RTCPeerConnection(config);

    pc.onicecandidate = (e) => {
      if (!e.candidate) {
        signalData.value = JSON.stringify(pc.localDescription);
        alert("このOfferを受信側に送ってください");
      }
    };

    localStream = await navigator.mediaDevices.getDisplayMedia({ video: true });
    localVideo.srcObject = localStream;
    localStream.getTracks().forEach(track => pc.addTrack(track, localStream));

    const offer = await pc.createOffer();
    await pc.setLocalDescription(offer);
  };

  // 受信者側：PeerConnection作成
  startReceiveBtn.onclick = () => {
    pc = new RTCPeerConnection(config);

    pc.onicecandidate = (e) => {
      if (!e.candidate) {
        signalData.value = JSON.stringify(pc.localDescription);
        alert("このAnswerを送信側に渡してください");
      }
    };

    pc.ontrack = (event) => {
      remoteVideo.srcObject = event.streams[0];
    };
  };

  // SDPのコピペ接続処理
  setSignalBtn.onclick = async () => {
    if (!pc) {
      alert("まず送信/受信どちらかを開始してください");
      return;
    }

    try {
      const desc = JSON.parse(signalData.value);

      if (desc.type === 'offer') {
        await pc.setRemoteDescription(desc);
        const answer = await pc.createAnswer();
        await pc.setLocalDescription(answer);
      } else if (desc.type === 'answer') {
        await pc.setRemoteDescription(desc);
      } else {
        alert("正しいSDPを貼り付けてください");
      }
    } catch (e) {
      alert("SDPの形式が正しくありません");
      console.error(e);
    }
  };
</script>

</body>
</html>
